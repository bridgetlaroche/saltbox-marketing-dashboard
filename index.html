<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Saltbox Marketing Dashboard</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; background: #f7f7f7; color: #4f525c; }
  h1, h2, h3, .section-title { font-family: 'Montserrat', sans-serif; }

  /* Password gate */
  #gate { position: fixed; inset: 0; background: #fff; display: flex; align-items: center; justify-content: center; z-index: 1000; }
  #gate.hidden { display: none; }
  #gate form { text-align: center; max-width: 380px; width: 90%; }
  #gate .gate-logo { width: 180px; margin-bottom: 2rem; }
  #gate h2 { font-size: 1.1rem; font-weight: 500; color: #4f525c; margin-bottom: 1.5rem; letter-spacing: 0.3px; }
  #gate input { width: 100%; padding: 0.85rem 1rem; border: 2px solid #efefef; border-radius: 8px; font-size: 1rem; font-family: 'Inter', sans-serif; margin-bottom: 1rem; transition: border-color 0.2s; }
  #gate input:focus { outline: none; border-color: #4f525c; }
  #gate button { width: 100%; padding: 0.85rem; background: #4f525c; color: #fff; border: none; border-radius: 8px; font-size: 0.95rem; font-family: 'Montserrat', sans-serif; font-weight: 600; cursor: pointer; transition: background 0.2s; letter-spacing: 0.3px; }
  #gate button:hover { background: #3a3d45; }
  #gate .error { color: #d63031; font-size: 0.85rem; margin-top: 0.5rem; display: none; }

  /* Header */
  header { background: #fff; border-bottom: 1px solid #efefef; padding: 1rem 2rem; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 1rem; }
  .header-left { display: flex; align-items: center; gap: 1.25rem; }
  .header-left img { height: 28px; }
  .header-divider { width: 1px; height: 24px; background: #ddd; }
  header h1 { font-size: 1rem; font-weight: 600; color: #4f525c; letter-spacing: 0.3px; }
  .header-right { display: flex; align-items: center; gap: 1.5rem; }
  .updated { font-size: 0.75rem; color: #999; }
  select { padding: 0.45rem 0.75rem; border-radius: 6px; border: 2px solid #efefef; background: #fff; color: #4f525c; font-size: 0.85rem; font-family: 'Inter', sans-serif; cursor: pointer; transition: border-color 0.2s; }
  select:focus { outline: none; border-color: #4f525c; }

  /* Main */
  main { max-width: 1440px; margin: 0 auto; padding: 2rem; }
  .section-title { font-size: 0.8rem; font-weight: 600; margin: 2rem 0 0.75rem; color: #999; text-transform: uppercase; letter-spacing: 1px; }

  /* KPI Cards */
  .kpi-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 1rem; margin-bottom: 1rem; }
  .kpi-card { background: #fff; border-radius: 10px; padding: 1.25rem; border: 1px solid #efefef; transition: box-shadow 0.2s; }
  .kpi-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.06); }
  .kpi-label { font-size: 0.7rem; font-family: 'Montserrat', sans-serif; color: #999; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.5rem; font-weight: 600; }
  .kpi-value { font-size: 1.5rem; font-weight: 700; font-family: 'Montserrat', sans-serif; color: #2d2d2d; }
  .kpi-change { font-size: 0.78rem; margin-top: 0.4rem; font-weight: 500; }
  .kpi-change.up { color: #00b894; }
  .kpi-change.down { color: #d63031; }
  .kpi-change.neutral { color: #999; }

  /* Location Table */
  .table-wrapper { overflow-x: auto; background: #fff; border-radius: 10px; border: 1px solid #efefef; margin-bottom: 2rem; }
  table { width: 100%; border-collapse: collapse; font-size: 0.83rem; }
  th { background: #4f525c; color: #fff; padding: 0.7rem 0.6rem; text-align: right; white-space: nowrap; position: sticky; top: 0; font-family: 'Montserrat', sans-serif; font-weight: 600; font-size: 0.72rem; letter-spacing: 0.3px; text-transform: uppercase; }
  th:first-child { text-align: left; border-radius: 10px 0 0 0; }
  th:last-child { border-radius: 0 10px 0 0; }
  td { padding: 0.6rem; text-align: right; border-bottom: 1px solid #f5f5f5; }
  td:first-child { text-align: left; font-weight: 600; white-space: nowrap; color: #2d2d2d; }
  tr:last-child td { font-weight: 700; background: #fafafa; border-top: 2px solid #efefef; }
  tr:hover td { background: #fffdf5; }
  .cell-up { color: #00b894; }
  .cell-down { color: #d63031; }

  /* Yellow accent bar on total row */
  tr:last-child td:first-child { border-left: 3px solid #fcec6b; }

  /* Charts */
  .charts-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(580px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
  .chart-card { background: #fff; border-radius: 10px; padding: 1.5rem; border: 1px solid #efefef; }
  .chart-card h3 { font-size: 0.85rem; color: #4f525c; margin-bottom: 1rem; font-weight: 600; }

  /* Responsive */
  @media (max-width: 1200px) {
    .kpi-grid { grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); }
  }
  @media (max-width: 768px) {
    .kpi-grid { grid-template-columns: repeat(2, 1fr); }
    .charts-grid { grid-template-columns: 1fr; }
    header { padding: 1rem; }
    main { padding: 1rem; }
  }
</style>
</head>
<body>

<!-- Password Gate -->
<div id="gate">
  <form onsubmit="return checkPassword()">
    <img class="gate-logo" src="https://cdn.prod.website-files.com/667d148040fe70ed2317d980/66850aeeb005c3356b1cbcb4_3e69ee38ad8cc295f36138958a6670e0_saltbox-logo%201.svg" alt="Saltbox">
    <h2>Marketing Dashboard</h2>
    <input type="password" id="pw" placeholder="Enter password" autocomplete="off" autofocus>
    <button type="submit">Access Dashboard</button>
    <div class="error" id="pwError">Incorrect password. Try again.</div>
  </form>
</div>

<!-- Dashboard -->
<div id="app" style="display:none">
  <header>
    <div class="header-left">
      <img src="https://cdn.prod.website-files.com/667d148040fe70ed2317d980/66850aeeb005c3356b1cbcb4_3e69ee38ad8cc295f36138958a6670e0_saltbox-logo%201.svg" alt="Saltbox">
      <div class="header-divider"></div>
      <h1>Marketing Dashboard</h1>
    </div>
    <div class="header-right">
      <select id="monthSelect" onchange="render()"></select>
      <div class="updated" id="updatedAt"></div>
    </div>
  </header>

  <main>
    <div class="section-title">Company Totals</div>
    <div class="kpi-grid" id="kpiCards"></div>

    <div class="section-title">By Location</div>
    <div class="table-wrapper">
      <table id="locTable">
        <thead id="locHead"></thead>
        <tbody id="locBody"></tbody>
      </table>
    </div>

    <div class="section-title">Trends</div>
    <div class="charts-grid" id="chartsGrid"></div>
  </main>
</div>

<script>
// --- Password ---
const PASS_HASH = '0c0e22a3a71484b5053543f8cf307bc1261fd45677660c3efdc9e94ba2114b06';
async function sha256(str) {
  const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(str));
  return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2, '0')).join('');
}
async function checkPassword() {
  const hash = await sha256(document.getElementById('pw').value);
  if (hash === PASS_HASH) {
    sessionStorage.setItem('sb_auth', '1');
    document.getElementById('gate').classList.add('hidden');
    document.getElementById('app').style.display = '';
    return false;
  }
  document.getElementById('pwError').style.display = 'block';
  return false;
}
if (sessionStorage.getItem('sb_auth') === '1') {
  document.getElementById('gate').classList.add('hidden');
  document.getElementById('app').style.display = '';
}

// --- KPI Metadata ---
const KPI_META = [
  { key: 'cac', label: 'CAC', fmt: '$', better: 'lower' },
  { key: 'corpCac', label: 'Corp CAC', fmt: '$', better: 'lower' },
  { key: 'allInCac', label: 'All In CAC', fmt: '$', better: 'lower' },
  { key: 'avgRevPerMember', label: 'Avg Rev/Member', fmt: '$', better: 'higher' },
  { key: 'avgMemberDuration', label: 'Avg Duration (mo)', fmt: 'num', better: 'higher' },
  { key: 'ltv', label: 'LTV', fmt: '$', better: 'higher' },
  { key: 'mktgSpendToRev', label: 'Mktg/Rev', fmt: '%', better: 'lower' },
  { key: 'corpMktgToRev', label: 'Corp Mktg/Rev', fmt: '%', better: 'lower' },
  { key: 'allInSpendToRev', label: 'All In/Rev', fmt: '%', better: 'lower' },
  { key: 'costPerLead', label: 'Cost/Lead', fmt: '$', better: 'lower' },
];

function fmtVal(v, fmt) {
  if (v == null) return '\u2014';
  if (fmt === '$') return '$' + v.toLocaleString('en-US', { maximumFractionDigits: 0 });
  if (fmt === '%') return (v * 100).toFixed(1) + '%';
  return v.toLocaleString('en-US', { maximumFractionDigits: 1 });
}

function changeDir(cur, prev, better) {
  if (cur == null || prev == null || prev === 0) return 'neutral';
  const diff = cur - prev;
  if (Math.abs(diff) < 0.001) return 'neutral';
  const improved = better === 'higher' ? diff > 0 : diff < 0;
  return improved ? 'up' : 'down';
}

function changePct(cur, prev) {
  if (cur == null || prev == null || prev === 0) return null;
  return ((cur - prev) / Math.abs(prev)) * 100;
}

// --- Data ---
let DATA = null;

async function loadData() {
  const resp = await fetch('data/dashboard-data.json');
  DATA = await resp.json();

  const sel = document.getElementById('monthSelect');
  sel.innerHTML = '';
  const months = [...DATA.months].reverse();
  months.forEach(m => {
    const opt = document.createElement('option');
    opt.value = m;
    const d = new Date(m + '-15');
    opt.textContent = d.toLocaleString('en-US', { month: 'long', year: 'numeric' });
    sel.appendChild(opt);
  });

  document.getElementById('updatedAt').textContent = 'Updated ' + new Date(DATA.lastUpdated).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
  render();
  renderCharts();
}

function getSelectedMonth() {
  return document.getElementById('monthSelect').value;
}

function getPriorMonth(month) {
  const idx = DATA.months.indexOf(month);
  return idx > 0 ? DATA.months[idx - 1] : null;
}

// --- Render KPI Cards ---
function renderKpiCards() {
  const month = getSelectedMonth();
  const prior = getPriorMonth(month);
  const cur = DATA.totals[month] || {};
  const prev = prior ? (DATA.totals[prior] || {}) : {};

  const container = document.getElementById('kpiCards');
  container.innerHTML = KPI_META.map(kpi => {
    const v = cur[kpi.key];
    const p = prev[kpi.key];
    const dir = changeDir(v, p, kpi.better);
    const pct = changePct(v, p);
    const arrow = dir === 'up' ? '\u25B2' : dir === 'down' ? '\u25BC' : '';
    const changeText = pct != null ? `${arrow} ${Math.abs(pct).toFixed(1)}% MoM` : '\u2014';
    return `<div class="kpi-card">
      <div class="kpi-label">${kpi.label}</div>
      <div class="kpi-value">${fmtVal(v, kpi.fmt)}</div>
      <div class="kpi-change ${dir}">${changeText}</div>
    </div>`;
  }).join('');
}

// --- Render Location Table ---
function renderTable() {
  const month = getSelectedMonth();
  const prior = getPriorMonth(month);

  const head = document.getElementById('locHead');
  head.innerHTML = '<tr><th>Location</th>' + KPI_META.map(k => `<th>${k.label}</th>`).join('') + '</tr>';

  const body = document.getElementById('locBody');
  const locs = [...DATA.locations, 'Total'];
  body.innerHTML = locs.map(loc => {
    const isTotal = loc === 'Total';
    const cur = isTotal ? (DATA.totals[month] || {}) : ((DATA.data[month] || {})[loc] || {});
    const prev = prior ? (isTotal ? (DATA.totals[prior] || {}) : ((DATA.data[prior] || {})[loc] || {})) : {};

    const cells = KPI_META.map(kpi => {
      const v = cur[kpi.key];
      const p = prev[kpi.key];
      const dir = changeDir(v, p, kpi.better);
      return `<td class="cell-${dir}">${fmtVal(v, kpi.fmt)}</td>`;
    }).join('');

    return `<tr><td>${loc}</td>${cells}</tr>`;
  }).join('');
}

function render() {
  renderKpiCards();
  renderTable();
}

// --- Charts ---
// Saltbox-inspired palette: charcoal, muted warm/cool tones
const CHART_COLORS = [
  '#4f525c', '#fcec6b', '#5b8c5a', '#e07a5f', '#3d405b',
  '#81b29a', '#f2cc8f', '#264653', '#e76f51', '#2a9d8f', '#9b5de5'
];

function renderCharts() {
  const grid = document.getElementById('chartsGrid');
  grid.innerHTML = '';

  const chartKpis = [
    { key: 'cac', label: 'Customer Acquisition Cost (CAC)' },
    { key: 'ltv', label: 'Lifetime Value (LTV)' },
    { key: 'costPerLead', label: 'Cost per Lead' },
    { key: 'avgRevPerMember', label: 'Avg Revenue per Member' },
  ];

  chartKpis.forEach(ck => {
    const card = document.createElement('div');
    card.className = 'chart-card';
    card.innerHTML = `<h3>${ck.label}</h3><canvas></canvas>`;
    grid.appendChild(card);

    const canvas = card.querySelector('canvas');
    const labels = DATA.months.map(m => {
      const d = new Date(m + '-15');
      return d.toLocaleString('en-US', { month: 'short', year: '2-digit' });
    });

    const datasets = DATA.locations.map((loc, i) => ({
      label: loc,
      data: DATA.months.map(m => (DATA.data[m] && DATA.data[m][loc]) ? DATA.data[m][loc][ck.key] : null),
      borderColor: CHART_COLORS[i % CHART_COLORS.length],
      backgroundColor: 'transparent',
      tension: 0.3,
      pointRadius: 3,
      borderWidth: 2,
    }));

    // Total as dashed line
    datasets.push({
      label: 'Total',
      data: DATA.months.map(m => DATA.totals[m] ? DATA.totals[m][ck.key] : null),
      borderColor: '#2d2d2d',
      backgroundColor: 'transparent',
      borderDash: [6, 3],
      tension: 0.3,
      pointRadius: 4,
      borderWidth: 2.5,
    });

    new Chart(canvas, {
      type: 'line',
      data: { labels, datasets },
      options: {
        responsive: true,
        interaction: { mode: 'index', intersect: false },
        plugins: {
          legend: {
            position: 'bottom',
            labels: { boxWidth: 12, font: { size: 11, family: 'Inter' }, color: '#4f525c' }
          },
          tooltip: {
            backgroundColor: '#4f525c',
            titleFont: { family: 'Montserrat', weight: '600' },
            bodyFont: { family: 'Inter' },
            callbacks: {
              label: function(ctx) {
                const meta = KPI_META.find(k => k.key === ck.key);
                return ctx.dataset.label + ': ' + fmtVal(ctx.parsed.y, meta ? meta.fmt : 'num');
              }
            }
          }
        },
        scales: {
          x: {
            ticks: { font: { family: 'Inter', size: 11 }, color: '#999' },
            grid: { color: '#f0f0f0' }
          },
          y: {
            beginAtZero: false,
            ticks: {
              font: { family: 'Inter', size: 11 },
              color: '#999',
              callback: function(val) {
                const meta = KPI_META.find(k => k.key === ck.key);
                if (meta && meta.fmt === '$') return '$' + val.toLocaleString();
                if (meta && meta.fmt === '%') return (val * 100).toFixed(0) + '%';
                return val;
              }
            },
            grid: { color: '#f0f0f0' }
          }
        }
      }
    });
  });
}

loadData();
</script>
</body>
</html>
